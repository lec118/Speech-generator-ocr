export const DEFAULT_STYLE_PROMPT = "{{STYLE_PROMPT}}";
export const STYLE_PROMPT_VERSION = "v2-tts-optimized";

export type LengthOption = "short" | "medium" | "long";
export type ToneOption = "basic" | "persuasive" | "explanatory" | "bullet";

export interface BuildPromptInput {
  topic?: string;
  pageIndex: number;
  pageText: string;
  length?: LengthOption;
  tone?: ToneOption;
}

const LENGTH_GUIDANCE: Record<LengthOption, string> = {
  short: "약 300~400자. 도입-해결-핵심보장-마무리 4단 구조. 한 페이지에 바로 요약.",
  medium: "약 500~700자. 6단 구조 (도입-문제인식-해결-핵심보장-마무리). 가장 많이 사용.",
  long: "약 800~1000자. 전체 6단 구조 + 예시/비교 포함. 상세 설명형, 교육자료 수준."
};

const TONE_GUIDANCE: Record<ToneOption, string> = {
  basic: "설명형 상담 톤. 존칭 일관('고객님', '~드립니다'). 구어체로 자연스럽게.",
  persuasive: "광고형 톤. 행동 촉구형 문장 강화. '지금 바로~', '이제는~', '놓치지 마세요' 활용.",
  explanatory: "쉬운 설명 + 예시 중심. '예를 들어~', '혹시~' 같은 공감형 질문 다수 활용.",
  bullet: "핵심 요점 나열형. '첫째, 둘째, 셋째' 형식. 숫자와 금액 강조. 빠르게 전달."
};

const MAX_SOURCE_CHARS = 6000;

/**
 * buildPrompt creates a TTS-optimized insurance speech script prompt
 */
export function buildPrompt({
  topic,
  pageIndex,
  pageText,
  length = "medium",
  tone = "basic"
}: BuildPromptInput): string {
  const normalizedTopic = topic?.trim() || "보험 상품";
  const normalizedText = pageText.trim().slice(0, MAX_SOURCE_CHARS);
  const trimmedText = normalizedText || "텍스트가 비어 있습니다.";

  return [
    "[시스템 목표]",
    "당신의 역할은 '보험상품 TTS 화법 생성기'입니다.",
    "입력된 상품 설명 자료(PDF 또는 이미지)를 분석하여, TTS(음성 낭독)에 최적화된 고객 상담용 대본을 생성합니다.",
    "출력은 마크다운 없이 바로 복사 가능한 평문으로 제공합니다.",
    "",
    "------------------------------------",
    "[입력 정보]",
    `상품명/주제: ${normalizedTopic}`,
    `페이지 번호: [p.${pageIndex + 1}]`,
    `요청 분량: ${LENGTH_GUIDANCE[length]}`,
    `요청 톤: ${TONE_GUIDANCE[tone]}`,
    "",
    "------------------------------------",
    "[출력 형식]",
    "1. 제목",
    "   (간편가입) [상품명] – [핵심 키워드 요약:  키워드1, 키워드2, 키워드3]",
    "",
    "2. 본문 (낭독용 대본, 마크다운 금지 / 줄바꿈 포함)",
    "",
    "------------------------------------",
    "[생성 구조 및 규칙]",
    "",
    "① 도입 (관심 유도형 질문)",
    "- '혹시~해보셨어요?' / '알고 계신가요?' 등 공감형 질문으로 시작",
    "- 트렌드, 통계, 비용, 실제 사례를 한두 문장 언급하여 공감 유도",
    "",
    "② 문제 인식 (위험·부담 강조)",
    "- 질병·상황의 위험성, 치료비 부담, 기존 보험의 한계 등 핵심만 간결하게 설명",
    "",
    "③ 해결 제안 (상품명 소개)",
    "- '한화생명에서 준비한 [상품명]을 소개해드리겠습니다.'",
    "- 간편가입, 체증형, 비급여, 환급형, 신규 특약 등 핵심 키워드 반드시 반영",
    "",
    "④ 핵심 보장 포인트 (3단 구성)",
    "- '첫째, … / 둘째, … / 셋째, …'",
    "- 보장 금액·횟수·범위를 한글+숫자 혼용 ('3천만 원', '1년에 2회' 등)",
    "",
    "⑤ 예시 또는 비교 (선택)",
    "- '예를 들어~'로 실제 보장 사례나 금액 비교를 자연스럽게 제시",
    "",
    "⑥ 마무리 (행동 촉구형)",
    "- '지금 바로~', '이제는~으로 대비하세요.' 등 긍정적 콜 투 액션으로 마무리",
    "- 마지막 문장은 리듬감 있게, 희망적 어조로 끝맺음",
    "",
    "------------------------------------",
    "[TTS 화법 톤 가이드]",
    "- 문장은 짧고 리듬감 있게, 쉼표(,)와 줄바꿈으로 자연스러운 호흡",
    "- 존칭 일관 ('안녕하세요 고객님.' '소개해드리겠습니다.')",
    "- 설명형 상담 톤 (요청 시 광고형으로 변경 가능)",
    "- 과도한 감탄사, 문어체, 마케팅성 표현 금지",
    "- 한 문장 15~20자 내외 권장",
    "- 숫자는 '3천만 원', '10년 납', '월 5만 원'처럼 읽기 쉽게 표기",
    "",
    "------------------------------------",
    "[중요 제약사항]",
    "- 마크다운 문법 절대 사용 금지 (**, ##, - 등)",
    "- 출력은 순수 평문으로만 작성",
    "- 제목과 본문 사이 한 줄 띄우기",
    "- 단락 사이 한 줄씩 띄워 가독성 확보",
    "",
    "------------------------------------",
    "[원본 자료]",
    "아래 보험 상품 설명 자료를 기반으로, 위 조건을 반드시 지켜 TTS 화법 대본을 작성하세요.",
    "",
    `"""`,
    trimmedText,
    `"""`,
    "",
    "------------------------------------",
    "[실행 지시]",
    "- 위 입력 정보를 기반으로, 고객 상담용 TTS 대본을 생성하라.",
    "- 출력은 오직 평문으로, 복사 즉시 음성합성(TTS)에 사용할 수 있어야 한다.",
    "- 제목과 본문만 출력하고, 다른 설명은 일체 포함하지 마라."
  ].join("\n");
}
